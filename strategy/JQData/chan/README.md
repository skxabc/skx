# 缠论买卖点策略

基于缠论的买卖点识别和回测策略，使用JQData数据源。

## 策略说明

### 买点定义

- **一买**：下跌趋势最后一个中枢后的背驰点（MACD底背离）
- **二买**：一买后的回调不破一买低点
- **三买**：突破中枢后的回调不破中枢上沿

### 卖点定义

- **一卖**：上涨趋势最后一个中枢后的背驰点（MACD顶背离）
- **二卖**：一卖后的反弹不破一卖高点
- **三卖**：跌破中枢后的反弹不破中枢下沿

## 买卖点触发条件详解

### 一买（第一类买点）

**触发条件（需同时满足）：**

1. **MACD底背离**：
   - 价格创新低：当前最低价 < 最近20天内的最低价
   - MACD不创新低：当前MACD柱状图值 > 最近20天内最低价对应的MACD值
   - 说明：价格继续下跌，但下跌动能减弱，可能出现反转

2. **下跌趋势确认**：
   - 当前收盘价 < 20天前的收盘价
   - 说明：确认处于下跌趋势中

**MACD计算方式：**
- MACD = EMA(12) - EMA(26)
- MACD信号线 = EMA(MACD, 9)
- MACD柱状图 = MACD - MACD信号线

**含义**：下跌趋势中的背驰点，通常是较好的买入时机。

---

### 二买（第二类买点）

**触发条件（需同时满足）：**

1. **前置条件**：必须先有一买信号
2. **回调确认**：
   - 在一买后20天内出现回调
   - 回调的最低点 ≥ 一买低点的98%（允许2%误差）
   - 回调最低点不能与一买是同一天
   - 说明：一买后回调不破一买低点，确认一买有效

**含义**：一买后的确认买点，通常比一买更安全，但可能错过最佳买入时机。

---

### 三买（第三类买点）

**触发条件（需同时满足）：**

1. **中枢识别**：
   - 前一日处于中枢内（至少9根K线的盘整区间，波动范围<10%）

2. **突破中枢**：
   - 当前收盘价 > 中枢上沿

3. **回调确认**：
   - 突破后10天内出现回调
   - 回调的最低点 ≥ 中枢上沿的99%（允许1%误差）
   - 说明：突破后回调不破中枢上沿，确认突破有效

**含义**：突破中枢后的确认买点，通常出现在上涨趋势中。

---

### 一卖（第一类卖点）

**触发条件（需同时满足）：**

1. **MACD顶背离**：
   - 价格创新高：当前最高价 > 最近20天内的最高价
   - MACD不创新高：当前MACD柱状图值 < 最近20天内最高价对应的MACD值
   - 说明：价格继续上涨，但上涨动能减弱，可能出现反转

2. **上涨趋势确认**：
   - 当前收盘价 > 20天前的收盘价
   - 说明：确认处于上涨趋势中

**含义**：上涨趋势中的背驰点，通常是较好的卖出时机。

---

### 二卖（第二类卖点）

**触发条件（需同时满足）：**

1. **前置条件**：必须先有一卖信号
2. **反弹确认**：
   - 在一卖后20天内出现反弹
   - 反弹的最高点 ≤ 一卖高点的102%（允许2%误差）
   - 反弹最高点不能与一卖是同一天
   - 说明：一卖后反弹不破一卖高点，确认一卖有效

**含义**：一卖后的确认卖点，通常比一卖更安全，但可能错过最佳卖出时机。

---

### 三卖（第三类卖点）

**触发条件（需同时满足）：**

1. **中枢识别**：
   - 前一日处于中枢内（至少9根K线的盘整区间，波动范围<10%）

2. **跌破中枢**：
   - 当前收盘价 < 中枢下沿

3. **反弹确认**：
   - 跌破后10天内出现反弹
   - 反弹的最高点 ≤ 中枢下沿的101%（允许1%误差）
   - 说明：跌破后反弹不破中枢下沿，确认跌破有效

**含义**：跌破中枢后的确认卖点，通常出现在下跌趋势中。

---

## 买卖点关系说明

- **一买/一卖**：基于背驰的独立信号，不依赖其他买卖点
- **二买/二卖**：必须在一买/一卖之后才能触发，是对一买/一卖的确认
- **三买/三卖**：基于中枢突破/跌破的独立信号，不依赖其他买卖点

**建议组合：**
- 保守型：只使用一买一卖（信号少但质量高）
- 平衡型：一买+二买，一卖+二卖（增加确认信号）
- 激进型：使用全部买卖点（信号多但可能频繁交易）

## 使用方法

### 基本用法

```bash
python3 chan_strategy.py --symbol 000001.XSHE --username 你的账号 --password 你的密码
```

### 参数说明

- `--symbol`: 标的代码（默认取环境变量 JQ_SYMBOL，否则 000001.XSHE）
- `--username`: JQData 账号（默认取环境变量 JQ_USERNAME）
- `--password`: JQData 密码（默认取环境变量 JQ_PASSWORD）
- `--start-date`: 回测开始日期，格式 YYYY-MM-DD（默认向前15个月）
- `--end-date`: 回测结束日期，格式 YYYY-MM-DD（默认向前3个月）

### 买卖点控制

默认所有买卖点都启用，可以通过参数禁用：

```bash
# 只使用一买和一卖
python3 chan_strategy.py --symbol 000001.XSHE --disable-buy2 --disable-buy3 --disable-sell2 --disable-sell3

# 只使用三买和三卖
python3 chan_strategy.py --symbol 000001.XSHE --disable-buy1 --disable-buy2 --disable-sell1 --disable-sell2
```

### 其他参数

- `--fee-rate`: 单边手续费率（默认 0.0005，即万5）
- `--slippage-bp`: 滑点，单位基点（默认 1.0，即0.01%）

## 示例

```bash
# 回测平安银行，使用所有买卖点
python3 chan_strategy.py --symbol 000001.XSHE --username 18813098345 --password 你的密码

# 回测浦发银行，只使用一买二买和一卖二卖
python3 chan_strategy.py --symbol 600000.XSHG --disable-buy3 --disable-sell3 --username 18813098345 --password 你的密码

# 指定回测时间段
python3 chan_strategy.py --symbol 000001.XSHE --start-date 2024-01-01 --end-date 2024-12-31 --username 18813098345 --password 你的密码
```

## 输出说明

策略会输出：
1. 识别到的所有买卖点信号
2. 交易记录（包含买卖点类型）
3. 绩效汇总（总收益、胜率、盈亏比等）

## 注意事项

1. 缠论策略需要足够的历史数据才能准确识别中枢和背驰
2. 本实现是简化版本，完整的缠论需要更复杂的笔、线段、中枢识别算法
3. 建议先用默认参数测试，再根据实际情况调整买卖点组合

